<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auslosung 5</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .button {
            margin: 10px 0;
            padding: 5px 10px;
            background-color: #3656A7;
            color: white;
            border: none;
            cursor: pointer;
        }
        .button:hover {
            background-color: #3656A7;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #000;
        }
        th, td {
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #3656A7;
            color: white;
        }
        td {
            background-color: #f2f2f2;
        }
        #draw-result {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Auslosung 5</h1>
    <button class="button" onclick="generateDraw()">Auslosung</button>
    <button class="button" onclick="window.location.href='vorrunde.html'">Zur Vorrunde</button>
    <button class="button" onclick="resetDraw()">Reset Auslosung</button>

    <div id="draw-result">
        <!-- Hier wird die Auslosung angezeigt -->
    </div>

    <script>
        const previousDraw = localStorage.getItem('auslosung5') || null;
        const existingMatches = JSON.parse(localStorage.getItem('matches')) || [];
        const teamsFromStorage = JSON.parse(localStorage.getItem('wattTeams')) || [];

        function generateDraw() {
            if (teamsFromStorage.length < 2) {
                alert("Es müssen mindestens 2 Teams vorhanden sein, um eine Auslosung zu machen.");
                return;
            }

            const teamNames = teamsFromStorage.map(team => `${team.player1} / ${team.player2}`);
            const shuffledTeams = shuffleArray(teamNames);

            let drawHTML = '<table><tr><th>Team 1</th><th>vs</th><th>Team 2</th><th>Tisch</th></tr>';
            let currentMatches = [];

            for (let i = 0; i < shuffledTeams.length; i += 2) {
                const match = `${shuffledTeams[i]} vs ${shuffledTeams[i + 1]}`;
                if (existingMatches.includes(match)) {
                    alert(`Die Paarung "${match}" existiert bereits. Versuche es mit einer neuen Auslosung.`);
                    return;
                }
                currentMatches.push(match);
                drawHTML += `<tr><td>${shuffledTeams[i]}</td><td>vs</td><td>${shuffledTeams[i + 1]}</td><td>Tisch ${Math.ceil(i / 2) + 1}</td></tr>`;
            }
            drawHTML += '</table>';

            localStorage.setItem('auslosung5', drawHTML);
            localStorage.setItem('matches', JSON.stringify([...existingMatches, ...currentMatches]));
            document.getElementById('draw-result').innerHTML = drawHTML;
        }

        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (previousDraw) {
                document.getElementById('draw-result').innerHTML = previousDraw;
            }
        });

        function resetDraw() {
            localStorage.removeItem('auslosung5');
            localStorage.removeItem('matches');
            document.getElementById('draw-result').innerHTML = '';
            alert("Die Auslosung wurde zurückgesetzt.");
        }
    </script>

<!-- Service Worker Registrierung -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/watt-turnier-app/service-worker.js")
    .catch(err => console.log("SW registration failed", err));
}
</script>

<!-- Versionsanzeige -->
<div id="app-version" 
     style="
       position:fixed;
       bottom:40px;
       right:10px;
       background:#eee;
       padding:5px 10px;
       border-radius:5px;
       font-size:12px;
       color:#333;
       z-index:999999;
     ">
  Version …
</div>

<!-- Update-Banner -->
<div id="update-banner" 
     style="
       display:none;
       position:fixed;
       bottom:80px;
       left:0;
       right:0;
       background:#3656A7;
       color:white;
       padding:15px;
       text-align:center;
       font-size:16px;
       z-index:999999;
     ">
  Neue Version verfügbar – tippe hier zum Aktualisieren
</div>

<script>
// Automatische Versionsanzeige
async function getAppVersion() {
  const versionBox = document.getElementById("app-version");
  if (!navigator.serviceWorker.controller) {
    versionBox.textContent = "Version lädt…";
    return;
  }

  const registration = await navigator.serviceWorker.getRegistration();
  if (!registration || !registration.active) return;

  registration.active.postMessage({ type: "GET_VERSION" });

  navigator.serviceWorker.addEventListener("message", event => {
    if (event.data.type === "VERSION") {
      versionBox.textContent = "Version " + event.data.version;
    }
  });
}

getAppVersion();

// Update-Banner anzeigen, wenn neuer SW aktiv wird
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.addEventListener("controllerchange", () => {
    const banner = document.getElementById("update-banner");
    if (banner) banner.style.display = "block";
  });
}

// Klick auf Banner → Seite neu laden
document.getElementById("update-banner").addEventListener("click", () => {
  location.reload();
});
</script>


</body>
</html>


